# -*- coding: utf-8 -*-

module Isono
  module NodeModules
    class NodeHeartbeat < Base

      config_section do |c|
        desc "second(s) to wait until send the next heartbeat signal"
        heartbeat_offset_time 10
      end

      initialize_hook do
        @timer = EventMachine::PeriodicTimer.new(config_section.heartbeat_offset_time.to_f) {
          rpc = RpcChannel.new(node)
          rpc.request('node-collector', 'notify', manifest.node_id, node.boot_token) do |req|
            req.oneshot = true
          end
        }
      end
      
      terminate_hook do
        @timer.cancel
      end
    end
  end
end
