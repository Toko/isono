# -*- coding: utf-8 -*-

module Isono
  module NodeModules
    class Base

      attr_reader :node

      def initialize(node)
        raise ArgumentError unless node.is_a?(Node)
        @node = node
        
        raise "Module initializer_hook is not run yet" if self.value_object.nil?
        value_object.copy_instance_variables(self)
      end
      
      # Delegate methods used in subclass frequently.
      def manifest
        node.manifest
      end

      def value_object
        node.value_objects[self.class]
      end

      # shortcut method to lookup configuration section only which
      # belongs to this class.
      def config_section
        node.manifest.config.send(self.class.instance_variable_get(:@config_section_name))
      end
      
      module ClassMethods
        def initialize_hook(&blk)
          @node_hooks[:initialize] = blk
        end
        
        def terminate_hook(&blk)
          @node_hooks[:terminate] = blk
        end

        def before_connect_hook(&blk)
          @node_hooks[:before_connect] = blk
        end

        def after_connect_hook(&blk)
          @node_hooks[:after_connect] = blk
        end
        
        def before_close_hook(&blk)
          @node_hooks[:before_close] = blk
        end

        def after_close_hook(&blk)
          @node_hooks[:after_close] = blk
        end

        def config_section(name=nil, &blk)
          @config_section_name = name unless name.nil? 
          @config_section_builder = blk
        end

        def node_hooks
          @node_hooks
        end
      end
      
      protected
      def self.inherited(klass)
        super
        klass.extend ClassMethods
        klass.class_eval {
          # set the default config section name from its class name.
          # can be overwritten later.
          @config_section_name = Util.snake_case(self.to_s.split('::').last)
          @node_hooks = {}
        }
      end
      
    end
  end
end
