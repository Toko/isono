# -*- coding: utf-8 -*-

module Isono
  module NodeModules
    class JobCollector < Base

      initialize_hook do
        rpc = RpcChannel.new(node)

        app = Rack::DataStore.new(Dispatch.new)
        
        rpc.register_endpoint('job-collector', app)
      end

      terminate_hook do
      end

      class Dispatch
        def record
          params = @req.args[0]
          params[:node_id]=@req.sender
          job =Models::JobState.find_or_create(:job_id=>params[:job_id])
          job.set_fields(params, [:parent_job_id, :session_id, :node_id, :state, :started_at, :finished_at, :job_name]).save_changes
        end
        
        def call(req, res)
          @req, @res = req, res
          raise Rack::UnknownMethodError if @req.command == 'call'
          m = self.method(@req.command)
          raise Rack::UnknownMethodError if m.nil?

          ret = m.call
          @res.response(nil)  if @res.responded?
        end
      end

    end
  end
end
